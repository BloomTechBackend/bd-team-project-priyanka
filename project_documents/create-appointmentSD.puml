@startuml
title Create Appointment

actor Client
participant "API Gateway" as APIGateway
participant Lambda
participant CreateAppointmentActivity
participant DoctorDao
participant UserDao
participant AppointmentDao
participant DoctorAvailabilityDao
participant DoctorAppointmentServiceUtils
participant ModelConverter
database DynamoDB

Client -> APIGateway : POST /createappointment
activate Client
APIGateway -> Lambda
activate Lambda
activate CreateAppointmentActivity
activate DoctorDao
activate UserDao
activate DoctorAvailabilityDao
Lambda -> CreateAppointmentActivity :  handleRequest(CreateAppointmentRequest, Context)
CreateAppointmentActivity -> DoctorDao : getDoctor(doctorId)
DoctorDao -> DynamoDB : load doctor by ID
alt if doctor ID does not exist
    DoctorDao <-- DynamoDB : null
    Lambda <-- DoctorDao : throw DoctorNotFoundException
    APIGateway <-- Lambda
    Client <-- APIGateway : 404 Response
else otherwise, continue
end
CreateAppointmentActivity -> UserDao : getUser(userId)
UserDao -> DynamoDB : load user by ID
alt if user ID does not exist
    UserDao <-- DynamoDB : null
    Lambda <-- UserDao : throw UserNotFoundException
    APIGateway <-- Lambda
    Client <-- APIGateway : 404 Response
else otherwise, continue
end
CreateAppointmentActivity -> DoctorAvailabilityDao : isAvailable(date,time)
alt if CreateAppointmentActivity <-- DoctorDao : false
     Lambda <-- CreateAppointmentActivity : throw NoSlotAvailableException
     APIGateway <-- Lambda
     Client <-- APIGateway : 4xx Response
else otherwise, continue
end

CreateAppointmentActivity -> DoctorAppointmentServiceUtils : generateAppointmentId()
CreateAppointmentActivity <-- DoctorAppointmentServiceUtils : new appointment ID

CreateAppointmentActivity -> CreateAppointmentActivity : populate Appointment object
CreateAppointmentActivity -> AppointmentDao : saveAppointment(Appointment)
AppointmentDao -> DynamoDB : save appointment
AppointmentDao <-- DynamoDB
CreateAppointmentActivity <-- AppointmentDao : Appointment



@enduml